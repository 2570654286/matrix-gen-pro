# 使用智创聚合 API 文档 MCP 编写插件

## 一、MCP 配置

你的 `mcp.json` 中已配置：

```json
{
  "mcpServers": {
    "智创聚合API - API 文档": {
      "command": "cmd /c npx -y apifox-mcp-server@latest --site-id=5484736",
      "args": [],
      "env": {}
    }
  }
}
```

- **apifox-mcp-server** 会拉取 Apifox 上 `site-id=5484736` 对应的智创聚合 API 文档。
- 在 Cursor 中需**重启或重载 MCP** 后，才可在对话里通过该 MCP 查询文档。

**`--site-id` 与 `--project-id` 说明：**

- 当前使用的是 `--site-id=5484736`，适用于 Apifox「分享/公开文档站点」。
- 若你用的是「Apifox 项目」方式，需改为 `--project-id=你的项目ID`，并在 `env` 中设置 `APIFOX_ACCESS_TOKEN`（在 Apifox 账号设置 → API 访问令牌 中创建）。例如：
  ```json
  "env": { "APIFOX_ACCESS_TOKEN": "你的令牌" }
  ```

---

## 二、用 MCP 查文档、填插件的具体步骤

**流程概览：** 用 MCP 在对话中查智创聚合的 API 文档 → 按**第三节《文档到代码的映射》**把文档内容填进 `src-tauri/plugins/zhichuang-provider.js`；若 MCP 暂时不可用，则按**第四节《手工填写清单》**从 Apifox 或智创官方文档中手动抄写后填入。

### 1. 在 Cursor 中启用并查询

1. **启用 MCP**  
   确保 Cursor 已加载上述 MCP（设置 → MCP 或对应配置页确认「智创聚合API - API 文档」已启用）。若刚改过 `mcp.json`，需**重启 Cursor 或重载 MCP**。

2. **在对话中让 AI 查文档**  
   在 Cursor 对话里直接说（AI 会通过 MCP 读取智创聚合的 Apifox 文档）：
   - 「请用**智创聚合 API 文档**（MCP）查：**视频生成**的提交接口：完整 URL、Method、请求体字段（如 model、prompt、aspect_ratio、duration 等）、响应里**任务 ID** 的字段名（如 id、data.id、task_id）。」
   - 「请用智创聚合 API 文档（MCP）查：**图生/文生图**接口的 URL、Method、请求体、以及是直接返回图片 URL 还是返回任务 ID。」
   - 「请用智创聚合 API 文档（MCP）查：**查询任务状态/结果**的接口：URL、Method、如何传任务 ID（path/query/body）、响应里**视频/图片 URL** 和 **status** 的字段路径。」
   - 「智创聚合有没有**角色/Character**的创建、列表、删除接口？若有，请给出 URL、Method、请求体或 path 参数。」

3. **MCP 工具说明**  
   `apifox-mcp-server` 会自动把 Apifox 文档暴露给 AI，常见能力包括：列出接口、获取某个接口的详细信息。你无需记住具体工具名，只要在提问中带上「智创聚合 API 文档」或「用 MCP 查智创聚合」即可，AI 会选用合适的方式读取。

4. **若提示「MCP 未找到」或「智创聚合API - API 文档 不可用」**  
   - 确认 `mcp.json` 中配置的 `command` 能在本机执行：在终端跑 `npx -y apifox-mcp-server@latest --site-id=5484736` 看是否报错。  
   - 若你用的是 `--project-id`，需在 `env` 里配置 `APIFOX_ACCESS_TOKEN`。  
   - 同时确认 Cursor 已重启或已重载 MCP。

### 2. 插件需要实现的接口

插件需导出 `plugin` 对象，并至少实现：

| 方法 | 用途 | 需要从 API 文档获取的内容 |
|------|------|---------------------------|
| `createRequest(params)` | 生成/生图/生视频的**提交请求** | 基础 URL、 path、Method、Headers（如 Authorization）、Body 结构（model、prompt、aspect_ratio、duration 等） |
| `parseTaskResponse(response)` | 解析**提交接口的响应** | 任务 ID 的字段（如 `id`、`data.id`、`task_id`）及「进行中」等状态字段 |
| `createStatusRequest(taskId, apiKey)` | 构建**轮询任务状态的请求** | 查进度的 URL、Method、Headers、如何传 taskId（query/body） |
| `parseVideoUrl(response)` | 解析**状态/结果接口的响应** | 完成时视频/图片 URL 的字段（如 `video_url`、`data.url`、`results[0].url`），以及 `completed`/`failed`/`processing` 等状态值 |

若智创提供**角色管理**（创建/列表/删除角色），可额外实现（参考 geeknow-provider）：

- `createCharacter(apiKey, videoUrl, timestamps?, fromTask?)`
- `getCharacterList(apiKey)`
- `deleteCharacter(apiKey, characterId)`

---

## 三、从文档到代码的映射

拿到 MCP 返回的文档后，按下面对照填到 `zhichuang-provider.js`：

1. **`createRequest`**
   - `baseUrl` / 基础 path：从文档的「请求 URL」或「服务地址」取。
   - `params.mediaType`：`'image'` / `'video'` 决定走图生还是视频生，对应文档里不同的接口。
   - `params.model`、`params.prompt`、`params.apiKey`、`params.aspectRatio`、`params.videoDuration`：按文档字段名写进 `body` 或 `headers`（如 `Authorization: Bearer {apiKey}`）。
   - 若文档要求 `multipart/form-data`，在返回对象中加 `useMultipart: true`，并按规定组 `body`。

2. **`parseTaskResponse`**
   - 从文档的「响应示例」找到任务 ID 和状态：
     - 任务 ID：如 `response.id`、`response.data.id`、`response.task_id` 等。
     - 状态：如 `response.status`、`response.data.status`，或无则默认 `'processing'`。
   - 返回 `{ taskId, status }`。

3. **`createStatusRequest`**
   - 从文档的「查询任务状态 / 结果」接口取：URL、Method、Headers。
   - 把 `taskId` 按文档要求放进 query、path 或 body；`apiKey` 放进 Header。

4. **`parseVideoUrl`**
   - 从文档的「状态/结果」响应里找：
     - 完成：`url` / `video_url` / `data.results[0].url` 等 → 作为 `url` 返回，`status: 'completed'`。
     - 失败：对应状态值 → `status: 'failed'`，`url: null`。
     - 进行中：→ `status: 'processing'` 或原样，`url: null`。
   - 若文档有 `progress`，可一并放入返回对象。

5. **角色接口（若有）**
   - `createCharacter`：文档里「创建角色」的 URL、Method、Body（如 `url`、`timestamps`）。
   - `getCharacterList`：列表接口的 URL、Method、Headers。
   - `deleteCharacter`：删除接口的 URL（一般 path 含 `characterId`）、Method、Headers。

---

## 四、手工填写清单（当 MCP 暂不可用时）

若 MCP 暂时不可用，你可以从 Apifox 或智创官方文档中手动查到下面信息，并到 `src-tauri/plugins/zhichuang-provider.js` 中按编号替换：

| 编号 | 在插件中的位置 | 需要从文档查到的内容 | 填入方式 |
|------|----------------|----------------------|----------|
| ① | `createRequest` 里 `baseUrl` | 服务根地址（如 `https://api.xxx.com`） | 替换 `https://api.zhichuang.example.com` |
| ② | `createRequest` 图生分支 `endpoint`、`body` | 图生接口 path、请求体字段（model、prompt、size、n、response_format 等） | 替换 `/v1/images/generations` 及 `body` 中各字段 |
| ③ | `createRequest` 视频分支 `endpoint`、`body` | 视频生成 path、请求体（model、prompt、size/ aspect_ratio、duration/seconds、webHook 等） | 替换 `/v1/videos` 及 `body`，按文档决定是否加 `useMultipart: true` |
| ④ | `parseTaskResponse` | 提交接口响应里**任务 ID** 的字段（如 `id`、`data.id`、`task_id`）；图生若**直接返回图片 URL**，则用 `response.data[0].url` 等判断 | 调整 `response.id` / `response.data?.id` / `response.task_id` 的取值顺序；图生直接完成时返回 `{ taskId: 'image-completed', status: 'completed' }`。若应用在 image 场景报 `Unexpected polling end`，需在 `pluginSystem.ts` 中为 `image-completed` 增加分支：用首次请求的 `response` 解析 URL 并直接 return |
| ⑤ | `createStatusRequest` 里 `baseUrl`、`url`、`method`、`body` | 查询任务状态/结果的 URL、Method；传 taskId 的方式（path 如 `/v1/videos/:id`、query、或 POST body 如 `{ id }`） | 替换 `baseUrl`、拼出 `url`；若是 POST+body，改为 `method:'POST'`, `body: { id: taskId }` |
| ⑥ | `parseVideoUrl` | 状态接口响应里：完成时 **URL** 的路径（如 `video_url`、`data.url`、`data.results[0].url`）；**status** 取值（如 `completed`、`succeeded`、`failed`、`processing`）；若有 `progress` | 按文档调整 `response.video_url`、`response.data?.url` 等分支；统一把完成、失败、进行中映射到 `status` 和 `url` |
| ⑦ | `createCharacter` / `getCharacterList` / `deleteCharacter` | 若文档有角色接口：创建（URL、body：url、timestamps 等）、列表（URL、Method）、删除（URL 含 characterId、Method） | 实现三个方法并 return 与 geeknow-provider 同结构的 `{ url, method, headers, body? }`；若文档无，保留 `throw new Error(...)` |

---

## 五、插件放置与加载

- **路径**：`src-tauri/plugins/zhichuang-provider.js`
- **打包**：`tauri.conf.json` 的 `bundle.resources` 已包含 `plugins/*`，该文件会被一起打包。
- **加载**：应用启动时会通过 `load_plugins_raw` 读取 `plugins` 目录下所有 `.js`，执行并取 `plugin`。  
  前端在「API 提供商」等下拉里会看到 `manifest.name`（如「智创聚合 Provider」）。

---

## 六、示例：向 AI 提问的句子（配合 MCP）

可直接在 Cursor 里对 AI 说：

- 「用智创聚合 API 的文档（MCP）查：视频生成提交接口的 URL、请求体、以及响应里任务 ID 的字段名。」
- 「智创聚合查任务状态/结果的接口是哪个？请求方式、URL、怎么传任务 ID，以及响应里视频 URL 和状态的字段。」
- 「智创聚合如果支持角色（character）创建，把创建、列表、删除三个接口的文档摘要发给我。」

AI 会通过 MCP 查 Apifox 文档并整理成可直接填入 `zhichuang-provider.js` 的格式，你再按第三节的映射关系补全骨架中的 `// TODO` 即可。
