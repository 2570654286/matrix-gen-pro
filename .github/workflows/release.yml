name: Release CI (Force Debug)

on:
  push:
    tags:
      - 'v*'

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: install frontend dependencies
        run: npm install

      # ===================================================
      # ç¬¬ä¸€å…³ï¼šç›´è§‰éªŒè¯ (æŸ¥çœ‹é’¥åŒ™åˆ°åº•æœ‰æ²¡æœ‰ä¼ è¿›æ¥)
      # ===================================================
      - name: Check Secrets (Debug)
        shell: pwsh
        env:
          MY_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          MY_PWD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: |
          if ([string]::IsNullOrEmpty($env:MY_KEY)) { 
            Write-Error "âŒ è‡´å‘½é—®é¢˜ï¼šGitHub Secrets é‡Œæ²¡æœ‰è¯»åˆ° TAURI_PRIVATE_KEYï¼è¯·æ£€æŸ¥å˜é‡åæ˜¯å¦å®Œå…¨ä¸€è‡´ï¼" 
            exit 1
          } else {
            Write-Host "âœ… ç§é’¥è¯»å–æˆåŠŸï¼é•¿åº¦: $($env:MY_KEY.Length)"
            Write-Host "ðŸ”‘ ç§é’¥å‰3ä½: $($env:MY_KEY.Substring(0,3))***"
          }
          
          if ([string]::IsNullOrEmpty($env:MY_PWD)) { 
             Write-Warning "âš ï¸ è­¦å‘Šï¼šå¯†ç  (TAURI_KEY_PASSWORD) ä¸ºç©ºï¼å¦‚æžœä½ çš„ç§é’¥æœ‰å¯†ç ï¼Œç­¾åå°†å¤±è´¥ã€‚"
          } else {
             Write-Host "âœ… å¯†ç è¯»å–æˆåŠŸï¼(å·²éšè—)"
          }

      # ===================================================
      # ç¬¬äºŒå…³ï¼šæš´åŠ›æž„å»º (å®Œå…¨å¤åˆ»ä½ çš„ BAT é€»è¾‘)
      # ===================================================
      - name: Build and Sign (Raw Command)
        # è¿™é‡Œä¸å†ä½¿ç”¨ tauri-actionï¼Œè€Œæ˜¯ç›´æŽ¥è¿è¡Œå‘½ä»¤ï¼Œä¸å†æœ‰é»‘ç®±æ“ä½œ
        run: npm run tauri build
        env:
          # åŒæ—¶æ³¨å…¥ä¸¤å¥—å˜é‡åï¼Œå®å¯å¤šç»™ï¼Œç»ä¸å°‘ç»™
          # æ ‡å‡†å˜é‡å
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          # ä½  BAT é‡Œç”¨çš„å˜é‡å (ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬ä¹Ÿä¼ è¿›åŽ»)
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

      # ===================================================
      # ç¬¬ä¸‰å…³ï¼šæ£€æŸ¥äº§ç‰© (æœ‰æ²¡æœ‰ .sig æ–‡ä»¶)
      # ===================================================
      - name: Verify Signature
        shell: pwsh
        run: |
          $Sig = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi.zip.sig"
          if ($Sig) { 
             Write-Host "ðŸŽ‰ æˆåŠŸï¼æ‰¾åˆ°äº†ç­¾åæ–‡ä»¶: $($Sig.Name)" 
          } else {
             Write-Error "ðŸ’€ å¤±è´¥ï¼ä¾ç„¶æ²¡æœ‰ç”Ÿæˆç­¾åæ–‡ä»¶ã€‚è¯·æŸ¥çœ‹ä¸Šä¸€æ­¥çš„æž„å»ºæ—¥å¿—ã€‚"
             exit 1
          }

      # ===================================================
      # ç¬¬å››å…³ï¼šæ‰‹åŠ¨å‘å¸ƒ (å› ä¸ºä¸ç”¨ tauri-action äº†ï¼Œæˆ‘ä»¬è‡ªå·±ä¸Šä¼ )
      # ===================================================
      - name: Generate latest.json and Upload
        shell: pwsh
        if: success() # åªæœ‰ä¸Šé¢æˆåŠŸäº†æ‰æ‰§è¡Œ
        run: |
          $Version = "${{ github.ref_name }}".Substring(1)
          $SigPath = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi.zip.sig" | Select-Object -First 1
          $ZipPath = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi.zip" | Select-Object -First 1
          $MsiPath = Get-ChildItem -Path "src-tauri/target/release/bundle/msi/*.msi" | Select-Object -First 1
          $ExePath = Get-ChildItem -Path "src-tauri/target/release/bundle/nsis/*.exe" | Select-Object -First 1
          
          $Signature = Get-Content $SigPath
          $ZipName = $ZipPath.Name
          $DownloadUrl = "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$ZipName"

          $JsonObj = @{
            version = $Version
            notes = "Auto update for ${{ github.ref_name }}"
            pub_date = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
            platforms = @{
              "windows-x86_64" = @{
                signature = $Signature
                url = $DownloadUrl
              }
            }
          }
          $JsonObj | ConvertTo-Json -Depth 5 | Out-File "latest.json" -Encoding utf8
          
          # è¾“å‡ºæ–‡ä»¶è·¯å¾„ä¾›ä¸‹ä¸€æ­¥ä¸Šä¼ ä½¿ç”¨
          echo "UPLOAD_JSON=latest.json" >> $env:GITHUB_ENV
          echo "UPLOAD_ZIP=$($ZipPath.FullName)" >> $env:GITHUB_ENV
          echo "UPLOAD_MSI=$($MsiPath.FullName)" >> $env:GITHUB_ENV
          echo "UPLOAD_EXE=$($ExePath.FullName)" >> $env:GITHUB_ENV

      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          files: |
            ${{ env.UPLOAD_JSON }}
            ${{ env.UPLOAD_ZIP }}
            ${{ env.UPLOAD_MSI }}
            ${{ env.UPLOAD_EXE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}